<!doctype html>
<html lang="en">

<head>
  {{> headerResources}}
  <title>The Forum</title>

  <link href="./stylesheets/loading.css" rel="stylesheet">

  <style>
    #loading-comments {
      display: none;
    }
  </style>

  <script>
    var username = "{{uname}}";

    function addComment(commentID, commentContent, commentAuthor, commentDate, commentScore) {
      var wholeCommentContainer = document.createElement("div");
      wholeCommentContainer.className = "comment-container";
      var mainCommentContainer = document.createElement("div");
      mainCommentContainer.className = "media comment ml-3";
      var voteContainer = document.createElement("div");
      voteContainer.className = "mr-3 commentactions";
      var upArrow = document.createElement("i");
      upArrow.className = "material-icons md-18 md-dark up";
      upArrow.innerHTML = "arrow_upward";
      var downArrow = document.createElement("i");
      downArrow.className = "material-icons md-18 md-dark down";
      downArrow.innerHTML = "arrow_downward";
      var commentBodyContainer = document.createElement("div");
      if (username)
        commentBodyContainer.className = "media-body";
      else
        commentBodyContainer.className = "media-body mb-3";
      commentBodyContainer.id = commentID;
      var flexContainer = document.createElement("div");
      flexContainer.className = "d-flex";
      var userNameContainer = document.createElement("h6");
      userNameContainer.className = "mt-0";
      var userName = document.createElement("a");
      userName.setAttribute("href", "user-profile?u=" + commentAuthor);
      userName.setAttribute("style", "color : #000000;");
      userName.innerHTML = commentAuthor;
      var commentScoreContainer = document.createElement("span");
      commentScoreContainer.className = "ml-2 points";
      commentScoreContainer.innerHTML = commentScore + " points";
      var separator = document.createElement("span");
      separator.className = "ml-2";
      separator.innerHTML = "·";
      var commentDateContainer = document.createElement("span");
      commentDateContainer.className = "ml-2 points";
      commentDateContainer.innerHTML = commentDate;
      var commentContentContainer = document.createElement("div");
      commentContentContainer.innerHTML = commentContent;
      var navContainer = document.createElement("div");
      navContainer.className = "nav-item active mt-2";
      var infoSpan = document.createElement("span");
      infoSpan.className = "info";
      var replyLink = document.createElement("a");
      replyLink.setAttribute("href", "");
      var commentIcon = document.createElement("i");
      commentIcon.className = "material-icons md-16 md-dark";
      commentIcon.innerHTML = "comment";
      var replyText = document.createElement("span");
      replyText.innerHTML = "Reply";

      voteContainer.append(upArrow);
      voteContainer.append(downArrow);
      userNameContainer.append(userName);
      flexContainer.append(userNameContainer);
      flexContainer.append(commentScoreContainer);
      flexContainer.append(separator);
      flexContainer.append(commentDateContainer);
      if (username) {
        replyLink.append(commentIcon);
        replyLink.append(replyText);
        infoSpan.append(replyLink);
        navContainer.append(infoSpan);
      }
      commentBodyContainer.append(flexContainer);
      commentBodyContainer.append(commentContentContainer);
      commentBodyContainer.append(navContainer);
      mainCommentContainer.append(voteContainer);
      mainCommentContainer.append(commentBodyContainer);
      wholeCommentContainer.append(mainCommentContainer);

      $("#allComments").append(wholeCommentContainer);
    }

    function addNestedComment(commentContainer, commentID, commentContent, commentAuthor, commentDate, commentScore) {
      var mainCommentContainer = document.createElement("div");
      mainCommentContainer.className = "media comment";
      mainCommentContainer.setAttribute("style", "margin-top: 20px");
      var voteContainer = document.createElement("div");
      voteContainer.className = "mr-3 commentactions";
      var upArrow = document.createElement("i");
      upArrow.className = "material-icons md-18 md-dark up";
      upArrow.innerHTML = "arrow_upward";
      var downArrow = document.createElement("i");
      downArrow.className = "material-icons md-18 md-dark down";
      downArrow.innerHTML = "arrow_downward";
      var commentBodyContainer = document.createElement("div");
      if (username)
        commentBodyContainer.className = "media-body";
      else
        commentBodyContainer.className = "media-body mb-3";
      commentBodyContainer.id = commentID;
      var flexContainer = document.createElement("div");
      flexContainer.className = "d-flex";
      var userNameContainer = document.createElement("h6");
      userNameContainer.className = "mt-0";
      var userName = document.createElement("a");
      userName.setAttribute("href", "user-profile?u=" + commentAuthor);
      userName.setAttribute("style", "color : #000000;");
      userName.innerHTML = commentAuthor;
      var commentScoreContainer = document.createElement("span");
      commentScoreContainer.className = "ml-2 points";
      commentScoreContainer.innerHTML = commentScore + " points";
      var separator = document.createElement("span");
      separator.className = "ml-2";
      separator.innerHTML = "·";
      var commentDateContainer = document.createElement("span");
      commentDateContainer.className = "ml-2 points";
      commentDateContainer.innerHTML = commentDate;
      var commentContentContainer = document.createElement("div");
      commentContentContainer.innerHTML = commentContent;
      var navContainer = document.createElement("div");
      navContainer.className = "nav-item active mt-2";
      var infoSpan = document.createElement("span");
      infoSpan.className = "info";
      var replyLink = document.createElement("a");
      replyLink.setAttribute("href", "");
      var commentIcon = document.createElement("i");
      commentIcon.className = "material-icons md-16 md-dark";
      commentIcon.innerHTML = "comment";
      var replyText = document.createElement("span");
      replyText.innerHTML = " Reply";

      voteContainer.append(upArrow);
      voteContainer.append(downArrow);
      userNameContainer.append(userName);
      flexContainer.append(userNameContainer);
      flexContainer.append(commentScoreContainer);
      flexContainer.append(separator);
      flexContainer.append(commentDateContainer);
      if (username) {
        replyLink.append(commentIcon);
        replyLink.append(replyText);
        infoSpan.append(replyLink);
        navContainer.append(infoSpan);
      }
      commentBodyContainer.append(flexContainer);
      commentBodyContainer.append(commentContentContainer);
      commentBodyContainer.append(navContainer);
      mainCommentContainer.append(voteContainer);
      mainCommentContainer.append(commentBodyContainer);

      $(commentContainer).append(mainCommentContainer);
    }

    function createNewComment() {
      $.post("createnewcomment", { postID: "{{postID}}", commentContent: $("#commentContent").val() }, (newComment) => {
        $("#commentContent").val("");
        addComment(newComment._id, newComment.commentContent, newComment.commentAuthor, newComment.commentDate, newComment.commentScore);
      })
    }

  </script>

</head>

<body>
  {{#if uname}} {{> signedNavBar}} {{else}} {{> unsignedNavBar}} {{/if}}
  <main role="main" class="container">
    <div class="starter-template">
      <!-- START OF POSTS SECTION -->
      <div class="media post">
        <div class="mr-3 actions">
          <i class="material-icons md-18 md-dark up">arrow_upward</i>
          <span class="votes">{{postScore}}</span>
          <i class="material-icons md-18 md-dark down">arrow_downward</i>
        </div>
        <div class="media-body">
          <h5 class="mt-0 mb-1">{{postTitle}}</h5>
          {{postDescription}}
          <div class="mt-2 flex-fill">
            <span class="info">
              <span class="p-2">
                <i class="material-icons md-16 md-dark">comment</i>
                <a href="#comments">{{commentNumber}} comments</a>
              </span>
              <span class="p-2">
                <i class="material-icons md-18 md-dark">person_outline</i> Posted by
                <a href="user-profile">{{postAuthor}}</a> at {{postDate}}
              </span>
          </div>
        </div>
      </div>

      {{#if uname}}
      <div class="postcomment">
        <h5 class="mt-0 mb-1">Replying as
          <a href="user-profile?u={{uname}}">{{uname}}</a>
        </h5>
        <div class="container-fluid">
          <textarea id="commentContent" class="form-control mt-3" type="text" placeholder="Type a comment"></textarea>
        </div>
        <button onclick="createNewComment();" class="btn btn-primary mt-2 ml-3">Submit</button>
      </div>
      {{else}}
      <div class="postcomment">
        <h5 class="mt-0 mb-3">Reply to post</h5>
        <div class="container-fluid">
          <form>
            <fieldset disabled>
              <input type="text" class="form-control mb-3" placeholder="What are your thoughts? Login or Register">
            </fieldset>
          </form>

        </div>
      </div>
      {{/if}}

      <a name="comments"></a>

      <div id="allComments"></div>

      <div id="loading-comments">
        <div class="comment-container">
          <div class="ml-3 media comment">
            <div class="mr-3 commentactions">
              <i class="material-icons md-18 md-dark">arrow_upward</i>
              <i class="material-icons md-18 md-dark">arrow_downward</i>
            </div>
            <div class="d-flex media-body">
              <div class="text">
                <div>
                  <span class="text-footer3"></span>
                  <span class="text-footer1"></span>
                </div>
                <div class="text-line"></div>
                <div class="text-line"></div>

              </div>
            </div>
          </div>
        </div>

        <div class="comment-container">
          <div class="ml-3 media comment">
            <div class="mr-3 commentactions">
              <i class="material-icons md-18 md-dark">arrow_upward</i>
              <i class="material-icons md-18 md-dark">arrow_downward</i>
            </div>
            <div class="d-flex media-body">
              <div class="text">
                <div>
                  <span class="text-footer3"></span>
                  <span class="text-footer1"></span>
                </div>
                <div class="text-line"></div>
                <div class="text-line"></div>

              </div>
            </div>
          </div>
        </div>

        <div class="comment-container">
          <div class="ml-3 media comment">
            <div class="mr-3 commentactions">
              <i class="material-icons md-18 md-dark">arrow_upward</i>
              <i class="material-icons md-18 md-dark">arrow_downward</i>
            </div>
            <div class="d-flex media-body">
              <div class="text">
                <div>
                  <span class="text-footer3"></span>
                  <span class="text-footer1"></span>
                </div>
                <div class="text-line"></div>
                <div class="text-line"></div>

              </div>
            </div>
          </div>
        </div>

        <div class="comment-container">
          <div class="ml-3 media comment">
            <div class="mr-3 commentactions">
              <i class="material-icons md-18 md-dark">arrow_upward</i>
              <i class="material-icons md-18 md-dark">arrow_downward</i>
            </div>
            <div class="d-flex media-body">
              <div class="text">
                <div>
                  <span class="text-footer3"></span>
                  <span class="text-footer1"></span>
                </div>
                <div class="text-line"></div>
                <div class="text-line"></div>

              </div>
            </div>
          </div>
        </div>

        <div class="comment-container">
          <div class="ml-3 media comment">
            <div class="mr-3 commentactions">
              <i class="material-icons md-18 md-dark">arrow_upward</i>
              <i class="material-icons md-18 md-dark">arrow_downward</i>
            </div>
            <div class="d-flex media-body">
              <div class="text">
                <div>
                  <span class="text-footer3"></span>
                  <span class="text-footer1"></span>
                </div>
                <div class="text-line"></div>
                <div class="text-line"></div>

              </div>
            </div>
          </div>
        </div>


      </div>
    </div>
  </main>

  {{> scriptResources}}


  <script>
    $(document).ready(function () {
      $(document).ajaxStart(function () {
        $("#loading-comments").css("display", "block");
      });

      $(document).ajaxComplete(function () {
        $("#loading-comments").css("display", "none");
      });

      $.post("getonepost", { postID: "{{postID}}" }, (foundPost) => {
        if (foundPost.comment.length > 0) {
          for (let i = 0; i < foundPost.comment.length; i++) {
            addComment(foundPost.comment[i]._id, foundPost.comment[i].commentContent, foundPost.comment[i].commentAuthor, foundPost.comment[i].commentDate, foundPost.comment[i].commentScore);
          }
        } else {
          var noComments = document.createElement("div");
          noComments.className = "comment-container";
          var icon = document.createElement("i");
          icon.className = "material-icons md-orange md-92 flex-fill";
          icon.innerHTML = "sentiment_very_dissatisfied";
          var content = document.createElement("div");
          content.className = "mt-3 mb-3 d-flex flex-column align-contents-center justify-contents-center";
          var text = document.createElement("h2");
          text.className = "flex-fill text-center";
          text.innerHTML = "No comments yet...";
          var subtext = document.createElement("h6");
          subtext.className = "mt-1 flex-fill text-center subheading";

          var username = "{{uname}}";
          if (username)
            subtext.innerHTML = "This place feels empty, why not start a discussion?";
          else
            subtext.innerHTML = "Login or register to start a discussion now.";
          content.append(icon);
          content.append(text);
          content.append(subtext);
          noComments.append(content);
          noComments.id = "noComment";
          $("#allComments").append(noComments);
        }
      })

    });
  </script>

</body>

</html>