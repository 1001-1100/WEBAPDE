<!doctype html>
<html lang="en">

<head>
  {{> headerResources}}
  <title>The Forum</title>
  <style type="text/css">
    .comment-container {
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  {{#if uname}} {{> signedNavBar}} {{else}} {{> unsignedNavBar}} {{/if}}
  <main role="main" class="container">
    <div class="row starter-template">
      <div class="col-lg-3">
        <div class="text-center mb-3 mt-5">
          <img class="avatar img-thumbnail" src="/user/avatar/{{avatar}}">
        </div>
        <div class="font-weight-bold">{{username}}</div>
        <div class="description">{{shortBio}}</div>
      </div>

      <div class="modal fade" id="editCommentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editCommentLabel">Edit comment</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <textarea class="form-control mt-3" type="text" id="inputCommentContent" rows="3"> </textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" id= "savechanges" class="btn btn-primary" data-dismiss="modal">Save changes</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="deleteCommentConfirmation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteCommentLabel">Delete comment</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this comment?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" id = "deleteCommentModal" class="btn btn-danger" data-dismiss="modal">Delete</button>
            </div>
          </div>
        </div>
      </div>


      <div class="col-lg-9">
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
          <li class="nav-item">
            <a class="nav-link active h3" id="user-posts-tab" data-toggle="pill" href="#user-posts" role="tab" aria-controls="user-posts"
              aria-selected="true">Posts</a>
          </li>
          <li class="nav-item">
            <a class="nav-link h3" id="user-comments-tab" data-toggle="pill" href="#user-comments" role="tab" aria-controls="user-comments"
              aria-selected="false">Comments</a>
          </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
          <div class="tab-pane fade show active" id="user-posts" role="tabpanel" aria-labelledby="user-posts-tab">
            <ul id="postContainer" class="list-unstyled"></ul>

            <div id="loadMorePosts" class="btn btn-outline-primary">See more posts</div>
          </div>

          <div class="tab-pane fade" id="user-comments" role="tabpanel" aria-labelledby="user-comments-tab">
            <ul id="commentContainer" class="list-unstyled"></ul>
              <div id="loadMoreComments" class="btn btn-outline-primary">See more comments</div>
            </ul>
            </div>
            </div>
            </div>
            </div>
  </main>


   <div class="modal fade" id="deletePostConfirmation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deletePostLabel">Delete post</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this post?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" id= "deletePostModal" class="btn btn-danger" data-dismiss="modal">Delete</button>
            </div>
          </div>
        </div>
      </div>
  {{> scriptResources}}

  <script>


    $(document).ready(function () {

      var username = "{{username}}";

      $("#postContainer").empty();
      $("#commentContainer").empty();

      $.post("/user/posts", {
        username: username
      }, (foundPosts) => {
        if (foundPosts.length > 0) {
          for (let i = 0; i < foundPosts.length; i++) {
            addPost(foundPosts[i]._id, foundPosts[i].postTitle, foundPosts[i].postDescription, foundPosts[i].postAuthor, foundPosts[i].postDate, foundPosts[i].postScore, foundPosts[i].commentNumber);
          }
        } else {
          addNoPosts()
        }
      })

      $.post("/user/comments", {
        username: username
      }, (foundUser) => {
        if (foundUser.comment.length > 0) {
          for (let i = 0; i < foundUser.comment.length; i++) {
            addComment(foundUser.comment[i]._id, foundUser.comment[i]._postID, foundUser.comment[i].commentContent, foundUser.comment[i].commentAuthor, foundUser.comment[i].commentDate, foundUser.comment[i].commentScore);
          }
        } else {

        }
      })

     

      /////////////////////////////////////////////////////////////////

      function addNoPosts() {
        var noPosts = document.createElement("div");
        noPosts.className = "comment-container";
        var icon = document.createElement("i");
        icon.className = "material-icons md-orange md-92 flex-fill";
        icon.innerHTML = "sentiment_very_dissatisfied";
        var content = document.createElement("div");
        content.className = "mt-3 mb-3 d-flex flex-column align-contents-center justify-contents-center";
        var text = document.createElement("h2");
        text.className = "flex-fill text-center";
        text.innerHTML = "No posts yet...";
        var subtext = document.createElement("h6");
        subtext.className = "mt-1 flex-fill text-center subheading";
        subtext.innerHTML = "Looks like this user hasn't posted anything.";
        content.append(icon);
        content.append(text);
        content.append(subtext);
        noPosts.append(content);
        noPosts.id = "noPost";
        $("#postContainer").append(noPosts);
      }
      
      function addNoComments() {
        var noPosts = document.createElement("div");
        noPosts.className = "comment-container";
        var icon = document.createElement("i");
        icon.className = "material-icons md-orange md-92 flex-fill";
        icon.innerHTML = "sentiment_very_dissatisfied";
        var content = document.createElement("div");
        content.className = "mt-3 mb-3 d-flex flex-column align-contents-center justify-contents-center";
        var text = document.createElement("h2");
        text.className = "flex-fill text-center";
        text.innerHTML = "No  comments yet...";
        var subtext = document.createElement("h6");
        subtext.className = "mt-1 flex-fill text-center subheading";
        subtext.innerHTML = "Looks like this user has no comments yet.";
        content.append(icon);
        content.append(text);
        content.append(subtext);
        noPosts.append(content);
        noPosts.id = "noPost";
        $("#commentContainer").append(noPosts);
      }

      function addPost(postIDs, postTitle, postDescription, postAuthor, postDate, postScore, commentNumber) {
        var mediaPost = document.createElement("div");
        mediaPost.className = "media post";
        var flexRow = document.createElement("div");
        flexRow.className = "d-flex flex-row w-100";
        var flexColumn = document.createElement("div");
        flexColumn.className = "media-body d-flex flex-column";
        var voteBox = document.createElement("div");
        voteBox.className = "mr-3 actions flex-column";
        var arrowUpward = document.createElement("i");
        arrowUpward.className = "material-icons md-18 md-dark up";
        arrowUpward.innerHTML = "arrow_upward";
        var voteValue = document.createElement("span");
        voteValue.className = "votes";
        voteValue.innerHTML = postScore;
        var arrowDownward = document.createElement("i");
        arrowDownward.className = "material-icons md-18 md-dark down";
        arrowDownward.innerHTML = "arrow_downward";
        var commentIcon = document.createElement("i");
        commentIcon.className = "material-icons md-16 md-dark";
        commentIcon.innerHTML = "comment";
        var personIcon = document.createElement("i");
        personIcon.className = "material-icons md-18 md-dark";
        personIcon.innerHTML = "person_outline";

        var postTitleContainer = document.createElement("a");
        postTitleContainer.setAttribute("href", "/post/" + postIDs);
        postTitleContainer.className = "mt-0 mb-1";
        postTitleContainer.innerHTML = postTitle;

        var postContent = document.createElement("div");
        postContent.innerHTML = postDescription;

        var postInfo = document.createElement("div");
        postInfo.className = "p-1 flex-fill";
        var spanInfo = document.createElement("span");
        spanInfo.className = "info";
        var spanComment = document.createElement("span");
        spanComment.className = "mr-3";
        var commentNumberContainer = document.createElement("a");
        commentNumberContainer.innerHTML = " ";
        commentNumberContainer.setAttribute("href", "/post/" + postIDs + "#comments");
        var spanUsername = document.createElement("span");
        spanUsername.className = "p-1";
        var userName = document.createElement("a");
        userName.innerHTML = postAuthor;
        userName.setAttribute("href", "/user/" + postAuthor);


        var icondelete = document.createElement("i");
        icondelete.innerHTML = "delete";
        icondelete.className = "material-icons md-16 md-dark icons material-actions";

        var iconedit = document.createElement("i");
        iconedit.innerHTML = "edit";
        iconedit.className = "material-icons md-16 md-dark icons material-actions";

        var deletespan = document.createElement("span");
        deletespan.className = "deleteSpan";
        deletespan.setAttribute("data-id", postIDs);
        deletespan.setAttribute("data-toggle", "modal");
        deletespan.setAttribute("data-target", "#deletePostConfirmation");
        deletespan.addEventListener("click", function () {
          //  var id = $(this).attr("data-id")
          //   console.log("ID of post is " + id);
         // deletePost(postIDs);
         document.getElementById("deletePostModal").setAttribute("data-id", postIDs)
        })
     
        
        var editspan = document.createElement("span");
        editspan.addEventListener("click", function () {
            window.location.href = "post/edit/" + postIDs;
        })
        //TODO
        //editspan.setAttribute("data-toggle", "modal");
        //editspan.setAttribute("data-target", "#editPostModal");
        //  var edita = document.createElement("a");
        editspan.append(iconedit);
        deletespan.append(icondelete);

        voteBox.append(arrowUpward);
        voteBox.append(voteValue);
        voteBox.append(arrowDownward);
        flexRow.append(voteBox);
        flexColumn.append(postTitleContainer);
        flexColumn.append(postContent);
        commentNumberContainer.append(commentIcon);
        commentNumberContainer.append(" " + commentNumber + " Comments");
        spanComment.append(commentNumberContainer);
        spanInfo.append(spanComment);
        spanUsername.append(personIcon);
        spanUsername.append("Posted by ");
        spanUsername.append(userName);
        spanUsername.append(" at " + postDate);
        spanInfo.append(spanUsername);
        postInfo.append(spanInfo);
        flexColumn.append(postInfo);
        flexRow.append(flexColumn);
        mediaPost.append(flexRow);
        flexRow.append(editspan);
        flexRow.append(deletespan);

        $("#postContainer").append(mediaPost);
      }

      function addComment(commentID, postID, commentContent, commentAuthor, commentDate, commentScore) {
        console.log("addComment commentID " + commentID)
        var wholeCommentContainer = document.createElement("div");
        wholeCommentContainer.className = "comment-container";
        var mainCommentContainer = document.createElement("div");
        mainCommentContainer.className = "media comment ml-3";
        var voteContainer = document.createElement("div");
        voteContainer.className = "mr-3 commentactions";
        var upArrow = document.createElement("i");
        upArrow.className = "material-icons md-18 md-dark up";
        upArrow.innerHTML = "arrow_upward";
        var downArrow = document.createElement("i");
        downArrow.className = "material-icons md-18 md-dark down";
        downArrow.innerHTML = "arrow_downward";
        var commentBodyContainer = document.createElement("div");
        if (username)
          commentBodyContainer.className = "media-body";
        else
          commentBodyContainer.className = "media-body mb-3";
        commentBodyContainer.id = postID;
        var flexContainer = document.createElement("div");
        flexContainer.className = "d-flex";
        var userNameContainer = document.createElement("h6");
        userNameContainer.className = "mt-0";
        var userName = document.createElement("a");
        userName.setAttribute("href", "user-profile?u=" + commentAuthor);
        userName.setAttribute("style", "color : #000000;");
        userName.innerHTML = commentAuthor;
        var commentScoreContainer = document.createElement("span");
        commentScoreContainer.className = "ml-2 points";
        commentScoreContainer.innerHTML = commentScore + " points";
        var separator = document.createElement("span");
        separator.className = "ml-2";
        separator.innerHTML = "Â·";
        var commentDateContainer = document.createElement("span");
        commentDateContainer.className = "ml-2 points";
        commentDateContainer.innerHTML = commentDate;
        var commentContentContainer = document.createElement("div");
        commentContentContainer.innerHTML = commentContent;
        var navContainer = document.createElement("div");
        navContainer.className = "mt-2";
        var infoSpan = document.createElement("span");
        infoSpan.className = "info";
        var replyLink = document.createElement("a");
        replyLink.setAttribute("href", "#");
        replyLink.setAttribute("data-id", postID);
        replyLink.addEventListener("click", function () {
          var id = $(this).attr("data-id")
          console.log("Reply clicked, id=" + id);

          var addCommentContainer = document.createElement("div")
          
          var txtComment = document.createElement("textarea")
          txtComment.setAttribute("oninput", "checkCommentBox();")
          txtComment.className = "form-control mt-2"
          txtComment.type = "text"
          txtComment.placeholder = "Type a comment"

          var btnSubmit = document.createElement("button")
          btnSubmit.disabled = true
          btnSubmit.setAttribute("onclick", "createNewComment()")
          btnSubmit.className = "btn btn-primary mt-2"
          btnSubmit.innerHTML = "Submit"

          var txtCommentContainer = document.createElement("div")
          txtCommentContainer.className = "container-fluid"

          txtCommentContainer.append(txtComment)
          txtCommentContainer.append(btnSubmit)

       
          addCommentContainer.append(txtCommentContainer)

          $(txtCommentContainer).appendTo(txtContainer).hide().slideDown(500)
        }, {
            once: true
          })

          ///
         var icondelete = document.createElement("i");
        icondelete.innerHTML = "delete";
        icondelete.className = "material-icons md-16 md-dark icons material-actions";

        var iconedit = document.createElement("i");
        iconedit.innerHTML = "edit";
        iconedit.className = "material-icons md-16 md-dark icons material-actions";

        var deletespan = document.createElement("span");
        deletespan.className = "deleteSpan";
        deletespan.setAttribute("data-postID", postID);
        deletespan.setAttribute("data-toggle", "modal");
        deletespan.setAttribute("data-target", "#deleteCommentConfirmation");
        deletespan.addEventListener("click", function () {
          //  var id = $(this).attr("data-id")
          //   console.log("ID of post is " + id);
         // deletePost(postIDs);
         document.getElementById("deleteCommentModal").setAttribute("data-postID", postID)
         document.getElementById("deleteCommentModal").setAttribute("data-commentID", commentID)
       
        })

        var editspan = document.createElement("span");
        editspan.addEventListener("click", function () {
          $("#inputCommentContent").val(commentContent)
        })

       // editspan.addEventListener("click", function () {
       //     window.location.href = "/post/editpost/"+postID;
       // })

        //TODO
        editspan.setAttribute("data-toggle", "modal");
        editspan.setAttribute("data-target", "#editCommentModal");
        editspan.addEventListener("click", function(){

          document.getElementById("editCommentModal").setAttribute("data-commentID", commentID)
          document.getElementById("editCommentModal").setAttribute("data-postID", postID)
        })


        editspan.append(iconedit);
        deletespan.append(icondelete);

///

        var commentIcon = document.createElement("i");
        commentIcon.className = "material-icons md-16 md-dark";
        commentIcon.innerHTML = "comment";
        var replyText = document.createElement("span");
        replyText.innerHTML = "Reply";

        var txtContainer = document.createElement("div")

        voteContainer.append(upArrow);
        voteContainer.append(downArrow);
        userNameContainer.append(userName);
        flexContainer.append(userNameContainer);
        flexContainer.append(commentScoreContainer);
        flexContainer.append(separator);
        flexContainer.append(commentDateContainer);
        flexContainer.append(editspan);
        flexContainer.append(deletespan);  
        if (username) {
          replyLink.append(commentIcon);
          replyLink.append(replyText);
          infoSpan.append(replyLink);
          navContainer.append(infoSpan);
        }
        commentBodyContainer.append(flexContainer);
        commentBodyContainer.append(commentContentContainer);
        commentBodyContainer.append(navContainer);
        commentBodyContainer.append(txtContainer)
        mainCommentContainer.append(voteContainer);
        mainCommentContainer.append(commentBodyContainer);
        wholeCommentContainer.append(mainCommentContainer);

        $("#commentContainer").append(wholeCommentContainer);
      }

      $("#savechanges").on("click", function(evt){
        var postID = $("#editCommentModal").attr("data-postID")
        var commentID = $("#editCommentModal").attr("data-commentID")
        var commentContent = $("#inputCommentContent").val();

          updateComment(postID, commentID, commentContent)
      })

      $('#deletePostModal').on('click',function(evt){
          var id = $(this).attr("data-id")
          deletePost(id)
        }
      );

      $('#deleteCommentModal').on('click',function(evt){
          var postid = $(this).attr("data-postID")
          var commentid = $(this).attr("data-commentID")
          
        console.log("user-profile postID is" + postid)
        console.log("user-profile commentID is" + commentid)
          deleteComment(postid, commentid)
        }
      );

      function updateComment(postID, commentID, commentContent){
        var username = "{{username}}";
        $("#commentContainer").empty();

        $.post("post/updateComment",{
            postID: postID,
            commentID: commentID,
            commentContent: commentContent,
            username: username
        },(foundUser)=>{
          console.log(foundUser)
           if (foundUser) {
                for (let i = 0; i < foundUser.comment.length; i++) {
                  addComment(foundUser.comment[i]._id, foundUser.comment[i]._postID, foundUser.comment[i].commentContent, foundUser.comment[i].commentAuthor, foundUser.comment[i].commentDate, foundUser.comment[i].commentScore);
                }
           } else {
                addNoComments()
              }

        })

      }

       function deleteComment(postID, commentID) {

          var username = "{{username}}";
          $("#commentContainer").empty();

          $.post("post/deletecomment", {
            postID: postID,
            commentID: commentID,
            username: username
          }, (foundUser) => { // returns the users list of post after deleting the said post already
              console.log(foundUser)
              if (foundUser) {
                for (let i = 0; i < foundUser.comment.length; i++) {
                  addComment(foundUser.comment[i]._id, foundUser.comment[i]._postID, foundUser.comment[i].commentContent, foundUser.comment[i].commentAuthor, foundUser.comment[i].commentDate, foundUser.comment[i].commentScore);
                }
              } else {
                addNoComments()
              }
          })
      }
  
      function deletePost(postID) {
          var username = "{{username}}";
          $("#postContainer").empty();

          $.post("post/deletepost", {
            id: postID,
            username: username
          }, (deletedPost) => { // returns the users list of post after deleting the said post already

            if (deletedPost) {
              for (let i = 0; i < deletedPost.post.length; i++) {
                addPost(deletedPost.post[i]._id, deletedPost.post[i].postTitle, deletedPost.post[i].postDescription, deletedPost.post[i].postAuthor, deletedPost.post[i].postDate, deletedPost.post[i].postScore, deletedPost.post[i].commentNumber);
              }
            } else {
              addNoPosts()
            }

          })
      }
    });
  </script>

</body>

</html>