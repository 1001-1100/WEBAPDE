<!doctype html>
<html lang="en">

<head>
  {{> headerResources}}
  <title>The Forum</title>
  <style type="text/css">
    .comment-container {
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  {{#if uname}} {{> signedNavBar}} {{else}} {{> unsignedNavBar}} {{/if}}
  <main role="main" class="container">
    <div class="row starter-template">
      <div class="col-lg-3">
        <div class="text-center mb-3 mt-5">
          <img class="avatar img-thumbnail" src="/user/avatar/{{avatar}}">
        </div>
        <div class="font-weight-bold">{{username}}</div>
        <div class="description">{{shortBio}}</div>
      </div>

      <div class="modal fade" id="editCommentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editCommentLabel">Edit comment</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <textarea class="form-control mt-3" type="text" id="inputPostContent" rows="3"> </textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" data-dismiss="modal">Save changes</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="deleteCommentConfirmation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteCommentLabel">Delete comment</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this comment?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" data-dismiss="modal">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="deletePostConfirmation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deletePostLabel">Delete post</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this post?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" data-dismiss="modal">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-9">
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
          <li class="nav-item">
            <a class="nav-link active h3" id="user-posts-tab" data-toggle="pill" href="#user-posts" role="tab" aria-controls="user-posts"
              aria-selected="true">Posts</a>
          </li>
          <li class="nav-item">
            <a class="nav-link h3" id="user-comments-tab" data-toggle="pill" href="#user-comments" role="tab" aria-controls="user-comments"
              aria-selected="false">Comments</a>
          </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
          <div class="tab-pane fade show active" id="user-posts" role="tabpanel" aria-labelledby="user-posts-tab">
            <ul id="postContainer" class="list-unstyled"></ul>

            <div id="loadMorePosts" class="btn btn-outline-primary">See more posts</div>
          </div>

          <div class="tab-pane fade" id="user-comments" role="tabpanel" aria-labelledby="user-comments-tab">
            <ul class="list-unstyled">
              <li class="comment-container">
                <div class="media comment ml-3">
                  <div class="mr-3 commentactions">
                    <i class="material-icons md-18 md-dark up">arrow_upward</i>
                    <i class="material-icons md-18 md-dark down">arrow_downward</i>
                  </div>
                  <div class="media-body">
                    <div class="d-flex">
                      <h6 class="mt-0">
                        <b>Kansei_Drift</b>
                      </h6>
                      <span class="ml-2 points">12 points</span>
                      <span class="ml-2">·</span>
                      <span class="ml-2 points">
                        <a href="/post">07/01/18 22:50</a>
                      </span>
                    </div>
                    Falling may cause long term damages. Tread with caution!
              </li>

              <li class="comment-container">
                <div class="media comment ml-3">
                  <div class="mr-3 commentactions">
                    <i class="material-icons md-18 md-dark up">arrow_upward</i>
                    <i class="material-icons md-18 md-dark down">arrow_downward</i>
                  </div>
                  <div class="media-body">
                    <div class="d-flex">
                      <h6 class="mt-0">
                        <b>Kansei_Drift</b>
                      </h6>
                      <span class="ml-2 points">12 points</span>
                      <span class="ml-2">·</span>
                      <span class="ml-2 points">
                        <a href="/post">07/01/18 22:50</a>
                      </span>
                    </div>
                    Falling may cause long term damages. Tread with caution!
              </li>

              <li class="comment-container">
                <div class="media comment ml-3">
                  <div class="mr-3 commentactions">
                    <i class="material-icons md-18 md-dark up">arrow_upward</i>
                    <i class="material-icons md-18 md-dark down">arrow_downward</i>
                  </div>
                  <div class="media-body">
                    <div class="d-flex">
                      <h6 class="mt-0">
                        <b>Kansei_Drift</b>
                      </h6>
                      <span class="ml-2 points">12 points</span>
                      <span class="ml-2">·</span>
                      <span class="ml-2 points">
                        <a href="/post">07/01/18 22:50</a>
                      </span>
                    </div>
                    Falling may cause long term damages. Tread with caution!
              </li>
              <div id="loadMoreComments" class="btn btn-outline-primary">See more comments</div>
            </ul>
            </div>
            </div>
            </div>
            </div>
  </main>
  {{> scriptResources}}

  <script>
    $(document).ready(function () {

      var username = "{{username}}";
      console.log("username is " + username);


      $.post("/user/posts", {
        username: username
      }, (foundPosts) => {
        $("#postContainer").empty();
        if (foundPosts.length > 0) {
          for (let i = 0; i < foundPosts.length; i++) {
            addPost(foundPosts._id, foundPosts.postTitle, foundPosts.postDescription, foundPosts.postAuthor, foundPosts.postDate, foundPosts.postScore, foundPosts.commentNumber);
          }
        } else {
          addNoPosts()
        }
      })


      /////////////////////////////////////////////////////////////////

      function addNoPosts() {
        var noPosts = document.createElement("div");
        noPosts.className = "comment-container";
        var icon = document.createElement("i");
        icon.className = "material-icons md-orange md-92 flex-fill";
        icon.innerHTML = "sentiment_very_dissatisfied";
        var content = document.createElement("div");
        content.className = "mt-3 mb-3 d-flex flex-column align-contents-center justify-contents-center";
        var text = document.createElement("h2");
        text.className = "flex-fill text-center";
        text.innerHTML = "No posts yet...";
        var subtext = document.createElement("h6");
        subtext.className = "mt-1 flex-fill text-center subheading";
        subtext.innerHTML = "Looks like this user hasn't posted anything.";
        content.append(icon);
        content.append(text);
        content.append(subtext);
        noPosts.append(content);
        noPosts.id = "noPost";
        $("#postContainer").append(noPosts);
      }
      /*
            var postIDs = []
            var postTitles = []
            var postDescriptions = []
            var postAuthors = []
            var postDates = []
            var postScores = []
            var commentNumbers = []
            { { #each postIDs } }
            postIDs.push("{{this}}")
            {
              {
                /each}}
                { { #each postTitles } }
                postTitles.push("{{this}}")
                {
                  {
                    /each}}
                    { { #each postDescriptions } }
                    postDescriptions.push("{{this}}")
                    {
                      {
                        /each}}
                        { { #each postAuthors } }
                        postAuthors.push("{{this}}")
                        {
                          {
                            /each}}
                            { { #each postDates } }
                            postDates.push("{{this}}")
                            {
                              {
                                /each}}
                                { { #each postScores } }
                                postScores.push("{{this}}")
                                {
                                  {
                                    /each}}
                                    { { #each commentNumbers } }
                                    commentNumbers.push("{{this}}")
                                    {
                                      {
                                        /each}}
      
                                        if (postIDs.length > 0) {
                                          for (let i = 0; i < postIDs.length; i++) {
                                            addPost(postIDs[i], postTitles[i], postDescriptions[i], postAuthors[i], postDates[i], postScores[i], commentNumbers[i]);
                                          }
                                        } else {
                                          $("#postContainer").append("No posts available");
                                        }
                                        $("#loadMorePosts").click(function () {
                                        });
      */
      function addPost(postIDs, postTitle, postDescription, postAuthor, postDate, postScore, commentNumber) {
        var mediaPost = document.createElement("div");
        mediaPost.className = "media post";
        var flexRow = document.createElement("div");
        flexRow.className = "d-flex flex-row w-100";
        var flexColumn = document.createElement("div");
        flexColumn.className = "media-body d-flex flex-column";
        var voteBox = document.createElement("div");
        voteBox.className = "mr-3 actions flex-column";
        var arrowUpward = document.createElement("i");
        arrowUpward.className = "material-icons md-18 md-dark up";
        arrowUpward.innerHTML = "arrow_upward";
        var voteValue = document.createElement("span");
        voteValue.className = "votes";
        voteValue.innerHTML = postScore;
        var arrowDownward = document.createElement("i");
        arrowDownward.className = "material-icons md-18 md-dark down";
        arrowDownward.innerHTML = "arrow_downward";
        var commentIcon = document.createElement("i");
        commentIcon.className = "material-icons md-16 md-dark";
        commentIcon.innerHTML = "comment";
        var personIcon = document.createElement("i");
        personIcon.className = "material-icons md-18 md-dark";
        personIcon.innerHTML = "person_outline";
        var postTitleContainer = document.createElement("a");
        postTitleContainer.setAttribute("href", "post?id=" + postIDs);
        postTitleContainer.className = "mt-0 mb-1";
        postTitleContainer.innerHTML = postTitle;
        var postContent = document.createElement("div");
        postContent.innerHTML = postDescription;
        var postInfo = document.createElement("div");
        postInfo.className = "p-1 flex-fill";
        var spanInfo = document.createElement("span");
        spanInfo.className = "info";
        var spanComment = document.createElement("span");
        spanComment.className = "mr-3";
        var commentNumberContainer = document.createElement("a");
        commentNumberContainer.innerHTML = " ";
        commentNumberContainer.setAttribute("href", "post?id=" + postIDs + "#comments");
        var spanUsername = document.createElement("span");
        spanUsername.className = "p-1";
        var userName = document.createElement("a");
        userName.innerHTML = postAuthor;
        userName.setAttribute("href", "user-profile?u=" + postAuthor);


        var icondelete = document.createElement("i");
        icondelete.innerHTML = "delete";
        icondelete.className = "material-icons md-16 md-dark icons material-actions";

        var iconedit = document.createElement("i");
        iconedit.innerHTML = "edit";
        iconedit.className = "material-icons md-16 md-dark icons material-actions";

        var deletespan = document.createElement("span");
        deletespan.className = "deleteSpan";
        deletespan.setAttribute("data-id", postIDs);
        deletespan.setAttribute("data-toggle", "modal");
        deletespan.setAttribute("data-target", "#deletePostConfirmation");
        deletespan.addEventListener("click", function () {
          //  var id = $(this).attr("data-id")
          //   console.log("ID of post is " + id);
          deletePost(postIDs);
        })

        var editspan = document.createElement("span");
        editspan.addEventListener("click", function () {
            window.location.href = "/editpost?id="+postIDs;
        })

        //TODO
        //editspan.setAttribute("data-toggle", "modal");
        //editspan.setAttribute("data-target", "#editPostModal");
        //  var edita = document.createElement("a");
        editspan.append(iconedit);
        deletespan.append(icondelete);

        voteBox.append(arrowUpward);
        voteBox.append(voteValue);
        voteBox.append(arrowDownward);
        flexRow.append(voteBox);
        flexColumn.append(postTitleContainer);
        flexColumn.append(postContent);
        commentNumberContainer.append(commentIcon);
        commentNumberContainer.append(" " + commentNumber + " Comments");
        spanComment.append(commentNumberContainer);
        spanInfo.append(spanComment);
        spanUsername.append(personIcon);
        spanUsername.append("Posted by ");
        spanUsername.append(userName);
        spanUsername.append(" at " + postDate);
        spanInfo.append(spanUsername);
        postInfo.append(spanInfo);
        flexColumn.append(postInfo);
        flexRow.append(flexColumn);
        mediaPost.append(flexRow);
        flexRow.append(editspan);
        flexRow.append(deletespan);

        $("#postContainer").append(mediaPost);
      }

      function deletePost(postID) {
        var username = "{{uname}}";
        $("#postContainer").empty();
        $.post("deletepost", {
          id: postID,
          username: username
        }, (deletedPost) => {

          if (deletedPost) {

            for (let i = 0; i < deletedPost.post.length; i++) {
              addPost(deletedPost.post[i]._id, deletedPost.post[i].postTitle, deletedPost.post[i].postDescription, deletedPost.post[i].postAuthor, deletedPost.post[i].postDate, deletedPost.post[i].postScore, deletedPost.post[i].commentNumber);
            }


          } else {
            addNoPosts()
          }


        })

      }
    });
  </script>

</body>

</html>